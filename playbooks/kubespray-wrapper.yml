---
- name: Kubespray wrapper - clone, install deps, run cluster deploy
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kubespray_repo: https://github.com/kubernetes-sigs/kubespray.git
    kubespray_dir: ./kubespray
    inventory_file: ../inventory/mycluster/hosts.yaml

  tasks:

    # ------------------------------
    # 1. Ensure prerequisite system packages
    # ------------------------------
    - name: Ensure required system packages are installed
      ansible.builtin.package:
        name:
          - git
          - python3-venv
          - python3-pip
        state: present

    # ------------------------------
    # 2. Clone Kubespray + Submodules
    # ------------------------------
    - name: Clone Kubespray repository
      ansible.builtin.git:
        repo: "{{ kubespray_repo }}"
        dest: "{{ kubespray_dir }}"
        version: "{{ kubespray_branch | default(omit) }}"
        force: yes

    - name: Initialize and update submodules
      ansible.builtin.command:
        cmd: git submodule update --init --recursive
      args:
        chdir: "{{ kubespray_dir }}"

    # ------------------------------
    # 3. Python Virtualenv
    # ------------------------------
    - name: Create Python virtualenv
      ansible.builtin.command:
        cmd: python3 -m venv "{{ kubespray_dir }}/.venv"
      args:
        creates: "{{ kubespray_dir }}/.venv/bin/activate"

    - name: Upgrade pip in the venv
      ansible.builtin.command:
        cmd: "{{ kubespray_dir }}/.venv/bin/pip install --upgrade pip setuptools wheel"

    - name: Ensure venv has pip (ensurepip fallback)
      ansible.builtin.command:
        cmd: "{{ kubespray_dir }}/.venv/bin/python -m ensurepip --upgrade"

    # ------------------------------
    # 4. Install Ansible + Kubespray dependencies
    # ------------------------------
    - name: Install ansible-core inside venv
      ansible.builtin.command:
        cmd: "{{ kubespray_dir }}/.venv/bin/pip install ansible-core"

    - name: Install Kubespray Python requirements
      ansible.builtin.command:
        cmd: "{{ kubespray_dir }}/.venv/bin/pip install -r requirements.txt"
      args:
        chdir: "{{ kubespray_dir }}"

    - name: Install Kubespray Galaxy roles
      ansible.builtin.command:
        cmd: "{{ kubespray_dir }}/.venv/bin/ansible-galaxy install -r requirements.yml"
      args:
        chdir: "{{ kubespray_dir }}"

    # ------------------------------
    # 5. Inventory Setup
    # ------------------------------
    - name: Ensure Kubespray inventory directory exists
      ansible.builtin.file:
        path: "{{ kubespray_dir }}/inventory/mycluster"
        state: directory
        mode: '0755'
        recurse: yes

    - name: Copy generated inventory into Kubespray
      ansible.builtin.copy:
        src: "{{ inventory_file }}"
        dest: "{{ kubespray_dir }}/inventory/mycluster/hosts.yaml"
        force: yes

    # ------------------------------
    # 6. Run the Kubespray cluster deployment
    # ------------------------------
    - name: Run Kubespray cluster deploy
      ansible.builtin.command:
        chdir: "{{ kubespray_dir }}"
        argv:
          - ./.venv/bin/ansible-playbook
          - -i
          - inventory/mycluster/hosts.yaml
          - cluster.yml
          - -b
          - -v
      environment:
        ANSIBLE_CONFIG: "{{ kubespray_dir }}/ansible.cfg"
